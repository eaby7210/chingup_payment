<!DOCTYPE html>
<html>
<head>
    <title>Payment Page</title>
    <style>
        #loading_message {
            text-align: center;
            padding: 50px;
            font-family: Arial, sans-serif;
        }
        #iframe_container {
            width: 100%;
        }
    </style>
    {% load bootstrap5 %}
    {% bootstrap_css %}
</head>
<body style="background-color:#000000c7">
    <div id="iframe_container" style="display: none;">
        <p id="loading_message">Loading payment gateway...</p>
        <iframe
          id="payment_iframe"
          src="https://chingup.com/card_payment/index.html"
          frameborder="0"
          width="100%"
          height="600"
          style="display: none;"
        ></iframe>
      </div>
      
      <script>
        const iframeContainer = document.getElementById("iframe_container");
        const loadingMessage = document.getElementById("loading_message");
        const iframe = document.getElementById("payment_iframe");
      
        let lastPaymentData = null;
        let paymentDataSent = false;
      
       
        window.addEventListener("message", function (event) {
          if (event.data?.type === "payment_initiate_props") {
            const {
              amount,
              currency,
              publishableKey,
              transactionId,
              css_configs,
            } = event.data;
      
            // Display the iframe loader
            iframeContainer.style.display = "block";
            loadingMessage.style.display = "block";
      
            // Reset and store the latest data
            {% comment %} lastPaymentData = {
              mode: "production",
              amount: amount,
              currency: currency,
              merchant_id: publishableKey,
              transaction_id: transactionId,
              type: "paymentData",
              css_config: css_configs,
              require_billing_info: true,
            }; {% endcomment %}


            lastPaymentData = {
                mode: "production",
                amount: 123,
                currency: "USD",
                merchant_id: "f6e5c7acb12cc27c3f7deef92831d590",
                transaction_id: "transactionId",
                type: "paymentData",
                css_config: css_configs,
                require_billing_info: true,
              };
      
            paymentDataSent = false;
      
            // Load iframe
            iframe.style.display = "none";
            iframe.src = "https://chingup.com/card_payment/index.html";
          }
        });
      
        // ‚úÖ Send payment data safely after iframe is ready
        function sendPaymentData() {
            console.log("inside send paymentdata")
            console.log("iframe?.contentWindow:", iframe?.contentWindow);
console.log("lastPaymentData:", lastPaymentData);
console.log("paymentDataSent:", paymentDataSent);

          if (iframe?.contentWindow && lastPaymentData && !paymentDataSent) {
            iframe.contentWindow.postMessage(lastPaymentData, "*");
            paymentDataSent = true;
            console.log("[parent] Sent paymentData to iframe");
          } else {
            console.warn("[parent] Iframe not ready or already sent or no data");
          }
        }
      
        // üîÅ Listen for messages back from the iframe
        window.addEventListener("message", function (event) {
          const response = event.data;
      
          // ‚úÖ Handle iframe readiness ping
          if (response?.type === "iframePing") {
            console.log("[parent] Iframe ping received");
            sendPaymentData();
            return;
          }
      
          // ‚úÖ Handle success
          if (response?.success) {
            console.log("[parent] Payment successful!", response);
            window.parent.postMessage(
              {
                type: "custom_element_success_response",
                data: {
                  transactionId: response.transaction_id,
                  message: "Payment Success!",
                },
              },
              "*"
            );
          }
      
          // ‚ùå Handle failure
          if (!response?.success) {
            console.log("[parent] Payment failed!", response);
            window.parent.postMessage(
              {
                type: "custom_element_error_response",
                data: {
                  transactionId: response.transaction_id,
                  message: "Payment Failed!",
                },
              },
              "*"
            );
          }
        });
      
        // üîÅ After iframe loads, wait for the ping before sending data
        iframe.onload = function () {
          console.log("[parent] Iframe loaded");
          iframe.style.display = "block";
          loadingMessage.style.display = "none";
          // NOTE: No postMessage here ‚Äî sendPaymentData will run after ping
        };
      </script>
      
</body>
</html>