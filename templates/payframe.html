<!DOCTYPE html>
<html>
<head>
    <title>Payment Page</title>
    <style>
        #loading_message {
            text-align: center;
            padding: 50px;
            font-family: Arial, sans-serif;
        }
        #iframe_container {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading message displayed initially -->
    <div id="loading_message">
        Waiting for payment information...
    </div>
    
    <!-- Iframe container (will be filled dynamically) -->
    <div id="iframe_container"></div>

    <script>
        const iframeContainer = document.getElementById('iframe_container');
        const loadingMessage = document.getElementById('loading_message');

        // Notify GHL that iframe is ready
        console.log("Iframe host ready. Dispatching 'custom_provider_ready' to GHL.");
        window.parent.postMessage(JSON.stringify({ type: 'custom_provider_ready', loaded: true }), "*");

        // 1Ô∏è‚É£ Listen for payment data from GHL
        window.addEventListener("message", function(event) {
            let data = event.data;

            // 2Ô∏è‚É£ Parse if it's a string
            if (typeof data === "string") {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    console.error("‚ùå Failed to parse event data:", e);
                    return;
                }
            }

            console.log("üì• Received event data:", data);

            if (data?.type === "payment_initiate_props") {
                const {
                    amount,
                    currency,
                    transactionId,
                    publishableKey // merchant_id
                } = data;

                if (!amount || !transactionId || !publishableKey) {
                    console.error("‚ùå Missing payment fields:", { amount, transactionId, publishableKey });
                    loadingMessage.innerHTML = "Error: Incomplete payment data. Please try again.";
                    return;
                }

                console.log("‚úÖ Valid payment data received:", JSON.stringify(data, null, 4));

                // 3Ô∏è‚É£ Create iframe only after receiving valid payment data
                const iframe = document.createElement('iframe');
                iframe.id = "payment_iframe";
                iframe.src = "https://chingup.com/card_payment/";
                iframe.style.width = "100%";
                iframe.style.height = "420px";
                iframe.frameBorder = "0";

                iframeContainer.appendChild(iframe);
                loadingMessage.style.display = "none";

                // 4Ô∏è‚É£ Send data to Chingup iframe once it's loaded
                iframe.onload = function () {
                    const chingupPaymentData = {
                        amount: parseFloat(amount),
                        currency: currency,
                        merchant_id: publishableKey,
                        transaction_id: transactionId,
                        type: "paymentData"
                    };

                    console.log("üì§ Sending payment data to Chingup:", chingupPaymentData);
                    iframe.contentWindow.postMessage(chingupPaymentData, "*");
                };
            }
        });

        // 5Ô∏è‚É£ Listen for Chingup's response
        window.addEventListener("message", function(event) {
            let response = event.data;

            if (typeof response === "string") {
                try {
                    response = JSON.parse(response);
                } catch (e) {
                    console.error("‚ùå Failed to parse response from Chingup:", e);
                    return;
                }
            }

            console.log("üì® Received response from Chingup:", response);

            if (response && typeof response === 'object' && 'success' in response) {
                if (response.success) {
                    console.log("‚úÖ Payment successful. Dispatching to GHL.");
                    window.parent.postMessage(JSON.stringify({
                        type: 'custom_element_success_response',
                        chargeId: String(response.ref_number || response.transaction_id || "N/A"),
                    }), "*");
                } else {
                    console.warn("‚ö†Ô∏è Payment failed. Dispatching error to GHL.");
                    window.parent.postMessage(JSON.stringify({
                        type: 'custom_element_error_response',
                        error: { description: response.message || "Payment failed" }
                    }), "*");
                }
            }
        });
    </script>
</body>
</html>
