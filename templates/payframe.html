<!DOCTYPE html>
<html>
<head>
    <title>Payment Page</title>
    <style>
        #loading_message {
            text-align: center;
            padding: 50px;
            font-family: Arial, sans-serif;
        }
        #iframe_container {
            width: 100%;
        }
    </style>
    {% load bootstrap5 %}
    {% bootstrap_css %}
</head>
<body style="background-color:#000000c7">
    <div id="iframe_container" style="display: none;">
        <p id="loading_message">Loading payment gateway...</p>
        <iframe
            id="payment_iframe"
            src="https://chingup.com/card_payment/index.html"
            frameborder="0"
            width="100%"
            height="600"
            style="display: none;"
        ></iframe>
    </div>

    <script>
        const iframeContainer = document.getElementById("iframe_container");
        const loadingMessage = document.getElementById("loading_message");
        const iframe = document.getElementById("payment_iframe");

        let lastPaymentData = null;
        let paymentDataSent = false;

        console.log("[init] Script initialized");
        console.log("Iframe loaded. Dispatching 'custom_provider_ready' event to GHL.");
        window.parent.postMessage(JSON.stringify({ type: 'custom_provider_ready', loaded: true }), "*");

        window.addEventListener("message", function (event) {
            console.log("[message] Event received:", event.data);
            let data = event.data;

            try {
                if (typeof data === "string") {
                    data = JSON.parse(data);
                }
            } catch (e) {
                console.warn("[message] Failed to parse message data:", e);
                return;
            }

            console.log("[message] Parsed Event Data:", data);
            if (event.data?.type === "payment_initiate_props") {
                console.log("[message] Received payment initiation request");

                const {
                    amount,
                    currency,
                    publishableKey,
                    transactionId,
                    css_configs,
                } = event.data;

                // Display the iframe loader
                iframeContainer.style.display = "block";
                loadingMessage.style.display = "block";

                // Store the latest data
                lastPaymentData = {
                    mode: "production",
                    amount: amount,
                    currency: currency,
                    merchant_id: publishableKey,
                    transaction_id: transactionId,
                    type: "paymentData",
                    css_config: css_configs,
                    require_billing_info: true,
                };
                console.log("[message] Stored payment data:", lastPaymentData);

                paymentDataSent = false;

                // Load iframe (reload to ensure clean state)
                iframe.style.display = "none";
                iframe.src = "https://chingup.com/card_payment/index.html";
                console.log("[message] Iframe reloaded");
            }

            // Handle iframePing
            if (event.data?.type === "iframePing") {
                console.log("[iframe] Ping received from iframe");
                sendPaymentData();
                return;
            }

            // Handle success response
            if (event.data?.success) {
                console.log("[iframe] Payment SUCCESS response:", event.data);
                window.parent.postMessage(
                    {
                        type: "custom_element_success_response",
                        data: {
                            transactionId: event.data.transaction_id,
                            message: "Payment Success!",
                        },
                    },
                    "*"
                );
                return;
            }

            // Handle failure response
            if (event.data?.success === false) {
                console.log("[iframe] Payment FAILURE response:", event.data);
                window.parent.postMessage(
                    {
                        type: "custom_element_error_response",
                        data: {
                            transactionId: event.data.transaction_id,
                            message: "Payment Failed!",
                        },
                    },
                    "*"
                );
                return;
            }

        });

        function sendPaymentData() {
            console.log("[sendPaymentData] Called");
            console.log("  ↳ iframe.contentWindow:", iframe?.contentWindow);
            console.log("  ↳ lastPaymentData:", lastPaymentData);
            console.log("  ↳ paymentDataSent:", paymentDataSent);

            if (iframe?.contentWindow && lastPaymentData && !paymentDataSent) {
                iframe.contentWindow.postMessage(lastPaymentData, "*");
                paymentDataSent = true;
                console.log("[sendPaymentData] Sent paymentData to iframe");
            } else {
                console.warn("[sendPaymentData] ❌ Conditions not met for sending data");
            }
        }

        iframe.onload = function () {
            console.log("[iframe] Iframe loaded");
            iframe.style.display = "block";
            loadingMessage.style.display = "none";
            // Do not send data here — wait for iframePing
        };
    </script>
</body>
</html>
